"use strict";var EMAIL="nikolay.hnatovskyi@gmail.com",commentsCount=0,isEditModeEnabled=!1,currentUser={name:"Kurt Thompson",avatar:"http://api.randomuser.me/portraits/thumb/men/69.jpg"};function getCommentsList(t,r){return new Promise(function(e,a){var n="http://frontend-test.pingbull.com/pages/"+EMAIL+"/comments";void 0!==t&&void 0!==r?n+="?count="+t+"&offset="+r:void 0!==t?n+="?count="+t:void 0!==r&&(n+="?offset="+r);var o=new XMLHttpRequest;o.open("GET",n,!0),o.onload=function(){var n=JSON.parse(o.responseText);if(4==o.readyState&&"200"==o.status)e(n);else{var t=new Error(this.statusText);t.code=this.status,a(t)}},o.onerror=function(){a(new Error("Network Error"))},o.send(null)})}function getSingleComment(t){return new Promise(function(e,a){var n="http://frontend-test.pingbull.com/pages/"+EMAIL+"/comments/",o=new XMLHttpRequest;o.open("GET",n+t,!0),o.onload=function(){var n=JSON.parse(o.responseText);if(4==o.readyState&&"200"==o.status)console.log(n),e(this.response);else{console.error(n);var t=new Error(this.statusText);t.code=this.status,a(t)}},o.onerror=function(){a(new Error("Network Error"))},o.send(null)})}function newComment(o,r){return new Promise(function(t,e){var n="http://frontend-test.pingbull.com/pages/"+EMAIL+"/comments";void 0!==o&&void 0!==r?n+="?content="+o+"&parent="+r:void 0!==o?n+="?content="+o:void 0===o&&console.log("Please, enter the message!");var a=new XMLHttpRequest;a.open("POST",n,!0),a.setRequestHeader("Content-type","application/json; charset=utf-8"),a.onload=function(){JSON.parse(a.responseText);if(4==a.readyState&&"201"==a.status)t(this.response);else{var n=new Error(this.statusText);n.code=this.status,e(n)}},a.onerror=function(){e(new Error("Network Error"))},a.send(null)})}function editComment(n,t){var e="http://frontend-test.pingbull.com/pages/"+EMAIL+"/comments/"+n;if(void 0!==t){e+="?content="+t;var a=new XMLHttpRequest;a.open("PUT",e,!0),a.setRequestHeader("Content-type","application/json; charset=utf-8"),a.onload=function(){var n=JSON.parse(a.responseText);4==a.readyState&&"200"==a.status?console.log(n):console.error(n)},a.send(null)}}function deleteComment(n){var t="http://frontend-test.pingbull.com/pages/"+EMAIL+"/comments/"+n,e=new XMLHttpRequest;e.open("DELETE",t,!0),e.send(null)}function renderCommentList(n){var e="",t=Array.from(n),a=/[0-9]{4}-(0[1-9]|1[012])-(0[1-9]|1[0-9]|2[0-9]|3[01])/,o=/([01]?[0-9]|2[0-3]):[0-5][0-9]/;t.forEach(function(t){commentsCount++,e+='\n        <div class="comment">\n            <div class="avatar">\n                <img src="'+t.author.avatar+'" alt="avatar">\n            </div>\n            <div class="comment__body">\n                <div class="comment__meta">\n                    <span class="comment__author">\n                        '+t.author.name+'\n                    </span>\n                    <span class="comment__date">\n                        <i class="fa fa-clock-o" aria-hidden="true"></i>\n                        <span>'+t.created_at.match(a)[0]+"</span> at \n                        <span>"+t.created_at.match(o)[0]+'</span>\n                    </span>\n                </div>\n                <div class="comment__text">\n                    '+t.content+'\n                </div>\n                <div class="comment__actions">\n                    <button onclick="toggleCommentForm(event); isEditMode(event);">\n                        <i class="fa fa-pencil-square-o" aria-hidden="true"></i> Edit\n                    </button>\n                    <button onclick="deleteCurrentComment(event, '+t.id+')">\n                        <i class="fa fa-times" aria-hidden="true"></i> Delete\n                    </button>\n                    <button onclick="toggleCommentForm(event)">\n                        <i class="fa fa-reply" aria-hidden="true"></i>Reply\n                    </button>\n                </div>\n                <div class="comment__form">\n                    <div class="comment__form-header">\n                        <span class="reply-to"><i class="fa fa-reply" aria-hidden="true"></i> '+t.author.name+'</span>\n                        <button class="cancel" onclick="toggleCommentForm(event)">\n                            <i class="fa fa-times" aria-hidden="true"></i> Cancel\n                        </button>\n                    </div>\n                    <form action="">\n                        <textarea placeholder="Your Message" name="" id="" cols="30" rows="6"></textarea>\n                        <input class="btn" type="button" value="Send" onclick="formButtonAction(event, '+t.id+', \'answer\')">\n                    </form>\n                </div>\n                <div class="comment__answers">',t.children.forEach(function(n){e+='\n                    <div class="comment comment_children">\n                        <div class="avatar">\n                            <img src="'+n.author.avatar+'" alt="avatar">\n                        </div>\n                        <div class="comment__body">\n                            <div class="comment__meta">\n                                <span class="comment__author">\n                                    '+n.author.name+'\n                                </span>\n                                <span class="comment__reply-to">\n                                    <i class="fa fa-reply" aria-hidden="true"></i> '+t.author.name+'\n                                </span>\n                                <span class="comment__date">\n                                    <i class="fa fa-clock-o" aria-hidden="true"></i>\n                                    <span>'+n.created_at.match(a)[0]+"</span> at \n                                    <span>"+n.created_at.match(o)[0]+'</span>\n                                </span>\n                            </div>\n                            <div class="comment__text">\n                                '+n.content+"\n                            </div>\n                        </div>\n                    </div>"}),e+="</div>\n            </div>\n        </div>"}),document.getElementById("comment-list").innerHTML+=e}function toggleCommentForm(n){isEditModeEnabled=!1;var t=$(n.target),e=t.parents(".comment__body").find(".comment__form"),a=t.parents(".comment__body").find("textarea");e.hasClass("comment__form_opened")?(e.removeClass("comment__form_opened"),a.val("")):e.addClass("comment__form_opened")}function sendComment(t,n,e){var a=$(t.target).parent("form").find("textarea"),o=a.val();switch(e){case"answer":newComment(o,n),showNewAnswer(t),toggleCommentForm(t),a.val("");break;case"comment":newComment(o).then(function(n){showNewComment(t),a.val("")},function(n){return console.log(n)})}isEditModeEnabled=!1}function deleteCurrentComment(n,t){$(n.target).parents(".comment").remove(),deleteComment(t)}function loadMoreComments(n){var t=$(n.target);getCommentsList(5,commentsCount).then(function(n){return renderCommentList(n)},function(n){return console.log(n)});var e="http://frontend-test.pingbull.com/pages/"+EMAIL+"/comments?count=99999",a=new XMLHttpRequest;a.open("GET",e,!1),a.onload=function(){var n=JSON.parse(a.responseText);4==a.readyState&&"200"==a.status?commentsCount>=n.length-5&&t.parent(".load-more").css("visibility","hidden"):console.error(n)},a.send(null)}function editCurrentComment(n,t){editComment(t,$(n.target).parent("form").find("textarea").val())}function isEditMode(n){isEditModeEnabled=!0;var t=$(n.target),e=t.parents(".comment__body").find("textarea"),a=t.parents(".comment__body").find(".comment__text").first().text();e.val(a.trim())}function formButtonAction(n,t,e){if(isEditModeEnabled){editCurrentComment(n,t);var a=$(n.target),o=a.parents(".comment__body").find(".comment__text").first(),r=a.parents(".comment__body").find("textarea");o.text(r.val()),r.val("")}else sendComment(n,t,e)}function showNewAnswer(n){var t=$(n.target),e=t.parent("form").find("textarea").val(),a=t.parents(".comment__body").find(".comment__answers"),o=t.parents(".comment:not(.comment_children)").find(".comment__meta .comment__author").first().text(),r='<div class="comment comment_children">\n        <div class="avatar">\n            <img src="'+currentUser.avatar+'" alt="avatar">\n        </div>\n        <div class="comment__body">\n            <div class="comment__meta">\n                <span class="comment__author">\n                    '+currentUser.name+'\n                </span>\n                <span class="comment__reply-to">\n                    <i class="fa fa-reply" aria-hidden="true"></i> '+o+'\n                </span>\n                <span class="comment__date">\n                    <i class="fa fa-clock-o" aria-hidden="true"></i>\n                    <span>'+getCurrentDate()+"</span> at \n                    <span>"+getCurrentTime()+'</span>\n                </span>\n            </div>\n            <div class="comment__text">\n                '+e+"\n            </div>\n        </div>\n    </div>";a.append(r)}function showNewComment(n){var t="",e=$(n.target).parent("form").find("textarea").val();getCommentsList(1).then(function(n){t='\n                <div class="comment">\n                    <div class="avatar">\n                        <img src="'+currentUser.avatar+'" alt="avatar">\n                    </div>\n                    <div class="comment__body">\n                        <div class="comment__meta">\n                            <span class="comment__author">\n                                '+currentUser.name+'\n                            </span>\n                            <span class="comment__date">\n                                <i class="fa fa-clock-o" aria-hidden="true"></i>\n                                <span>'+getCurrentDate()+"</span> at \n                                <span>"+getCurrentTime()+'</span>\n                            </span>\n                        </div>\n                        <div class="comment__text">\n                            '+e+'\n                        </div>\n                        <div class="comment__actions">\n                            <button onclick="toggleCommentForm(event); isEditMode(event);">\n                                <i class="fa fa-pencil-square-o" aria-hidden="true"></i> Edit\n                            </button>\n                            <button onclick="deleteCurrentComment(event, '+n[0].id+')">\n                                <i class="fa fa-times" aria-hidden="true"></i> Delete\n                            </button>\n                            <button onclick="toggleCommentForm(event)">\n                                <i class="fa fa-reply" aria-hidden="true"></i>Reply\n                            </button>\n                        </div>\n                        <div class="comment__form">\n                            <div class="comment__form-header">\n                                <span class="reply-to"><i class="fa fa-reply" aria-hidden="true"></i> Kurt Thompson</span>\n                                <button class="cancel" onclick="toggleCommentForm(event)">\n                                    <i class="fa fa-times" aria-hidden="true"></i> Cancel\n                                </button>\n                            </div>\n                            <form action="">\n                                <textarea placeholder="Your Message" name="" id="" cols="30" rows="6"></textarea>\n                                <input class="btn" type="button" value="Send" onclick="formButtonAction(event, '+n[0].id+', \'answer\')">\n                            </form>\n                        </div>\n                        <div class="comment__answers"></div>\n                    </div>\n                </div>\n            ',$("#comment-list").prepend(t)},function(n){return console.log(n)})}function setCommentsNumber(){getCommentsList(99999).then(function(n){return $(".comments-number").text(n.length)},function(n){return console.log(n)})}function getCurrentDate(){return formatDate(new Date)}function formatDate(n){var t=n.getDate();t<10&&(t="0"+t);var e=n.getMonth()+1;return e<10&&(e="0"+e),n.getFullYear()+"-"+e+"-"+t}function getCurrentTime(){var n=new Date(Date.now());return n.getHours()-3+":"+(n.getMinutes()+9)}getCommentsList().then(function(n){return renderCommentList(n)},function(n){return console.log(n)}),$(".comment_leave").find("img").attr("src",currentUser.avatar),setCommentsNumber(),Array.from||(Array.from=function(){var t=Object.prototype.toString,m=function(n){return"function"==typeof n||"[object Function]"===t.call(n)},a=Math.pow(2,53)-1,c=function(n){var t,e=(t=Number(n),isNaN(t)?0:0!==t&&isFinite(t)?(0<t?1:-1)*Math.floor(Math.abs(t)):t);return Math.min(Math.max(e,0),a)};return function(n){var t=Object(n);if(null==n)throw new TypeError("Array.from requires an array-like object - not null or undefined");var e,a=1<arguments.length?arguments[1]:void 0;if(void 0!==a){if(!m(a))throw new TypeError("Array.from: when provided, the second argument must be a function");2<arguments.length&&(e=arguments[2])}for(var o,r=c(t.length),s=m(this)?Object(new this(r)):new Array(r),i=0;i<r;)o=t[i],s[i]=a?void 0===e?a(o,i):a.call(e,o,i):o,i+=1;return s.length=r,s}}());